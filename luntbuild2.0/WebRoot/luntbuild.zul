<?xml version="1.0" encoding="utf-8" ?>
<?taglib uri="/WEB-INF/tld/web/core.dsp.tld" prefix="c" ?>
<?page title="Luntbuild Dashboard"?>
<?link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"?>
<?component name="importexport" macro-uri="/importexport.zul"?>
<?component name="generalprefs" macro-uri="/generalprefs.zul"?>
<?component name="emailprefs" macro-uri="/emailprefs.zul"?>
<?component name="msnprefs" macro-uri="/msnprefs.zul"?>
<?component name="jabberprefs" macro-uri="/jabberprefs.zul"?>
<?component name="sametimeprefs" macro-uri="/sametimeprefs.zul"?>
<?component name="templatedit" macro-uri="/templatedit.zul"?>
<?component name="users" macro-uri="/users.zul"?>
<?component name="selectusers" macro-uri="/selectusers.zul"?>
<?component name="searchbuilds" macro-uri="/searchbuilds.zul"?>
<?component name="movebuilds" macro-uri="/movebuilds.zul"?>
<?component name="manualbuild" macro-uri="/manualbuild.zul"?>
<?component name="projectedit" macro-uri="/projectedit.zul"?>
<?component name="selectproject" macro-uri="/selectproject.zul"?>
<?component name="vcsedit" macro-uri="/vcsedit.zul"?>
<?component name="builderedit" macro-uri="/builderedit.zul"?>
<?component name="scheduledit" macro-uri="/scheduledit.zul"?>
<?component name="loginmapping" macro-uri="/loginmapping.zul"?>

<zk
	xmlns="http://www.zkoss.org/2005/zul"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.zkoss.org/2005/zul http://www.zkoss.org/2005/zul/zul.xsd">

<window title="Luntbuild Dashboard" border="normal">
    <style src="/css/luntbuild.css"/>
	<caption>
	    <label value="Version 2.0 prototype "/>
		<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		<toolbarbutton label=" Web Site " href="http://luntbuild.javaforge.com"/>
	</caption>
    <style src="/css/luntbuild.css"/>

	<zscript>
		void confirmStopBuild() {
			if (Messagebox.show("Are you sure you want to stop the build?", "Stop Build",
					Messagebox.YES | Messagebox.NO, Messagebox.QUESTION) == Messagebox.YES) {
				// TODO stop the build
			}
		}
	</zscript>

<!-- Manubar and toolbar -->
	<menubar id="menubar" autodrop="true">
		<menu label="Project">
			<menupopup>
				<menuitem label="New..." image="/img/icon_new.png" onClick="projectnewwin.doOverlapped()"/>
				<menuitem label="Edit..." image="/img/edit.gif" onClick="projecteditwin.doOverlapped()"/>
				<menuitem label="Copy..." image="/img/copy.gif" onClick="projectcopywin.doOverlapped()"/>
				<menuitem label="Delete..." image="/img/delete.gif" onClick="projectdeletewin.doOverlapped()"/>
				<menuseparator/>
				<menuitem label="Logout" image="/img/logout.png" onClick="alert(self.label)"/>
			</menupopup>
		</menu>
		<menu label="Build">
			<menupopup>
				<menuitem label="Run..." image="/img/icon_run.png" onClick="manualbuildwin.doOverlapped()"/>
				<menuitem label="Stop..." image="/img/icon_stop.png" onClick="confirmStopBuild()"/>
				<menuseparator/>
				<menuitem label="History Builds..." image="/img/history_builds.gif"
					onClick="dashboardtabs.setSelectedTab(tab_historybuilds)"/>
				<menuitem label="Search Builds..." image="/img/search.png"
					onClick="searchbuildswin.doOverlapped();dashboardtabs.setSelectedTab(tab_historybuilds)"/>
				<menuitem label="Promote Builds..." image="/img/move.gif" onClick="movebuildswin.doOverlapped()"/>
			</menupopup>
		</menu>
		<menu label="Users">
			<menupopup>
				<menuitem label="New..." image="/img/user.gif" onClick="userwin.doOverlapped()"/>
				<menuitem label="Edit..." image="/img/edit.gif" onClick="edituserwin.doOverlapped()"/>
				<menuitem label="Copy..." image="/img/copy.gif" onClick="copyuserwin.doOverlapped()"/>
				<menuitem label="Delete..." image="/img/delete.gif" onClick="deleteuserwin.doOverlapped()"/>
			</menupopup>
		</menu>
		<menu label="Tools">
			<menupopup>
				<menuitem label="Save/Restore" image="/img/dirAndfile.gif" onClick="saverestore.doOverlapped()"/>
				<menuseparator/>
				<menuitem label="System Log" image="/img/log.gif" href="/luntbuild_log.html"/>
				<menuseparator/>
				<menu label="Edit Templates" image="/img/property.gif">
					<menupopup>
						<menuitem label="Blog" image="/img/property.gif" onClick="blogtemplatewin.doOverlapped()"/>
						<menuitem label="Email" image="/img/property.gif" onClick="emailtemplatewin.doOverlapped()"/>
						<menuitem label="MSN" image="/img/property.gif" onClick="msntemplatewin.doOverlapped()"/>
						<menuitem label="Jabber" image="/img/property.gif" onClick="jabbertemplatewin.doOverlapped()"/>
						<menuitem label="Sametime" image="/img/property.gif" onClick="sametimetemplatewin.doOverlapped()"/>
					</menupopup>
				</menu>
				<menuseparator/>
				<menu label="Properties" image="/img/property.gif">
					<menupopup>
						<menuitem label="General" image="/img/property.gif" onClick="generalprefswin.doOverlapped()"/>
						<menuitem label="Email" image="/img/property.gif" onClick="emailprefswin.doOverlapped()"/>
						<menuitem label="MSN" image="/img/property.gif" onClick="msnprefswin.doOverlapped()"/>
						<menuitem label="Jabber" image="/img/property.gif" onClick="jabberprefswin.doOverlapped()"/>
						<menuitem label="Sametime" image="/img/property.gif" onClick="sametimeprefswin.doOverlapped()"/>
					</menupopup>
				</menu>
			</menupopup>
		</menu>
		<menu label="Help">
			<menupopup>
				<menuitem label="Help Contents" image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
				<menuseparator/>
				<menuitem label="Check for Updates" image="/img/folder_update.png" href="http://www.javaforge.com/proj/doc.do?doc_id=1205"/>
				<menuseparator/>
				<menuitem label="About Luntbuild" image="/img/about.gif" href="http://luntbuild.javaforge.com"/>
			</menupopup>
		</menu>
	</menubar>
	<toolbar>
		<toolbarbutton label="New" image="/img/icon_new.png" tooltip="new-project-tip" onClick="projectnewwin.doOverlapped()"/>
		<space bar="true"/>
		<toolbarbutton label="Run" image="/img/icon_run.png" tooltip="run-build-tip" onClick="manualbuildwin.doOverlapped()"/>
		<toolbarbutton label="Stop" image="/img/icon_stop.png" tooltip="stop-build-tip" onClick="confirmStopBuild()"/>
		<toolbarbutton label="History" image="/img/history_builds.gif" tooltip="history-builds-tip"
			onClick="dashboardtabs.setSelectedTab(tab_historybuilds)"/>
		<toolbarbutton label="Promote" image="/img/move.gif" tooltip="promote-builds-tip" onClick="movebuildswin.doOverlapped()"/>
		<space bar="true"/>
		<toolbarbutton label="Help" image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
	</toolbar>
	<menupopup id="projectPopup">
		<menuitem label="Edit..." image="/img/edit.gif" onClick="projecteditwin.doOverlapped()"/>
		<menuitem label="Copy..." image="/img/copy.gif" onClick="projectcopywin.doOverlapped()"/>
	</menupopup>
	<menupopup id="schedulePopup">
		<menuitem label="Run" image="/img/icon_run.png" onClick="manualbuildwin.doOverlapped()"/>
		<menuitem label="Stop" image="/img/icon_stop.png" onClick="confirmStopBuild()"/>
		<menuseparator/>
		<menuitem label="History" image="/img/history_builds.gif" onClick="dashboardtabs.setSelectedTab(tab_historybuilds)"/>
		<menuitem label="Search Builds..." image="/img/search.png"
			 onClick="searchbuildswin.doOverlapped();dashboardtabs.setSelectedTab(tab_historybuilds)"/>
		<menuitem label="Promote Build..." image="/img/move.gif" onClick="movebuildswin.doOverlapped()"/>
	</menupopup>
	<menupopup id="historyBuildsPopup">
		<menuitem label="Search Builds..." image="/img/search.png"
			 onClick="searchbuildswin.doOverlapped()"/>
		<menuitem label="Promote Build..." image="/img/move.gif" onClick="movebuildswin.doOverlapped()"/>
	</menupopup>
	<popup id="new-project-tip" width="150px">
		<hbox>
			<label value="${c:l('new.project.tip')}"/>
			<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		</hbox>
	</popup>
	<popup id="run-build-tip" width="150px">
		<hbox>
			<label value="${c:l('run.build.tip')}"/>
			<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		</hbox>
	</popup>
	<popup id="stop-build-tip" width="150px">
		<hbox>
			<label value="${c:l('stop.build.tip')}"/>
			<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		</hbox>
	</popup>
	<popup id="history-builds-tip" width="150px">
		<hbox>
			<label value="${c:l('history.builds.tip')}"/>
			<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		</hbox>
	</popup>
	<popup id="promote-builds-tip" width="150px">
		<hbox>
			<label value="${c:l('promote.builds.tip')}"/>
			<toolbarbutton image="/img/icon_help.png" href="http://luntbuild.javaforge.com/manual/guide/index.html"/>
		</hbox>
	</popup>

<!-- Overlapped windows and modal dialogs -->

	<window id="projectnewwin" title="Create new Project" width="900px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <projectedit/>
	</window>

	<window id="projecteditwin" title="Edit Project" width="900px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <projectedit edit="true"/>
	</window>

	<window id="projectdeletewin" title="Select Project to Delete" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <selectproject delete="true"/>
	</window>

	<window id="projectcopywin" title="Select Project to Copy" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <selectproject copy="true"/>
	</window>

	<window id="vcseditwin" title="Edit Version Control" width="800px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <vcsedit edit="${arg.edit}" project="projectname"/>
	</window>

	<window id="buildereditwin" title="Edit Builder" width="900px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <builderedit edit="${arg.edit}" project="${arg.projectname}"/>
	</window>

	<window id="scheduleditwin" title="Edit Schedule" width="900px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <scheduledit edit="${arg.edit}" project="${arg.projectname}"/>
	</window>

	<window id="loginmappingwin" title="Login Mapping" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <loginmapping edit="${arg.edit}" project="${arg.projectname}"/>
	</window>

	<window id="manualbuildwin" title="Manual build" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <manualbuild/>
	</window>

	<window id="movebuildswin" title="Promote builds" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <movebuilds/>
	</window>

	<window id="searchbuildswin" title="Search builds" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <searchbuilds/>
	</window>

	<window id="deleteuserwin" title="Select User to Delete" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <selectusers delete="true"/>
	</window>

	<window id="copyuserwin" title="Select User to Copy" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <selectusers copy="true"/>
	</window>

	<window id="edituserwin" title="Select User to Edit" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <selectusers edit="true"/>
	</window>

	<window id="userwin" title="New User" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <users cancreate="true"/>
	</window>

	<window id="blogtemplatewin" title="Edit Blog Templates" width="750px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <templatedit type="blog"/>
	</window>

	<window id="emailtemplatewin" title="Edit Email Templates" width="750px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <templatedit type="email"/>
	</window>

	<window id="msntemplatewin" title="Edit MSN Templates" width="750px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <templatedit type="msn"/>
	</window>

	<window id="jabbertemplatewin" title="Edit Jabber Templates" width="750px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <templatedit type="jabber"/>
	</window>

	<window id="sametimetemplatewin" title="Edit Sametime Templates" width="750px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <templatedit type="sametime"/>
	</window>

	<window id="generalprefswin" title="General Preferences" width="550px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <generalprefs/>
	</window>

	<window id="emailprefswin" title="Email Preferences" width="500px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <emailprefs/>
	</window>

	<window id="msnprefswin" title="MSN Preferences" width="500px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <msnprefs/>
	</window>

	<window id="jabberprefswin" title="Jabber Preferences" width="500px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <jabberprefs/>
	</window>

	<window id="sametimeprefswin" title="Sametime Preferences" width="500px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <sametimeprefs/>
	</window>

	<window id="saverestore" title="Save/Restore Luntbuild" width="500px"
	  closable="true" sizable="true" onClose="self.visible = false; event.stopPropagation();" visible="false" border="normal">
	  <importexport/>
	</window>

<!-- Main pane with schedule tree, queue and build pane -->
	<hbox spacing="0" style="border: 1px solid grey" width="100%">
		<zscript>
			projects = new String[] {"Project 1", "Project 2", "Project 3"};
			schedules = new String[] {"Schedule 1", "Schedule 2", "Schedule 3"};
			stateImage = new String[] {"/img/running.gif", "/img/success.gif", "/img/failed.gif"};
		</zscript>
		<tree id="projecttree" style="border: 0px" width="200px" onSelect="projectTreeSelected()">
			<treecols sizable="false">
				<treecol label="Schedules"/>
				<treecol label="Status"/>
			</treecols>
			<treechildren>
				<treeitem forEach="${projects}">
					<treerow>
						<treecell label="${each}" context="projectPopup"/>
					</treerow>
					<treechildren>
						<treeitem forEach="${schedules}">
							<treerow>
								<treecell label="${each}" context="schedulePopup"/>
								<treecell image="${stateImage[forEachStatus.index]}" context="schedulePopup"/>
							</treerow>
						</treeitem>
					</treechildren>
				</treeitem>
			</treechildren>
			<zscript>
				void projectTreeSelected() {
					Treeitem item = projecttree.getSelectedItem();
					if (item == null) {
						return;
					} else {
						if (item.getLevel() == 0) {
							dashboardtabs.setSelectedTab(tab_project);
						} else {
							dashboardtabs.setSelectedTab(tab_build);
						}
					}
				}
			</zscript>
		</tree>
		<!-- TODO Update projecttree and buildpanel
		<timer id="timer" delay="10000" repeats="true" onTimer=""/>
-->
		<tabbox id="dashboardtabs" style="border: 0px" width="100%" onCreate="loadTabData()" onSelect="loadTabData()">
			<tabs>
				<tab id="tab_build" label="Build"/>
				<tab id="tab_historybuilds" label="History Builds"/>
				<tab id="tab_project" label="Project"/>
				<tab id="tab_queue" label="Queue"/>
			</tabs>
			<tabpanels>
				<tabpanel id="buildtab" context="schedulePopup"/>
				<tabpanel id="historybuildstab" context="historyBuildsPopup"/>
				<tabpanel id="projecttab" context="schedulePopup"/>
				<tabpanel id="queuetab" context="schedulePopup"/>
			</tabpanels>
			<zscript><![CDATA[
			void loadTabData() {
			Tabpanel panel = dashboardtabs.getSelectedPanel();
			if (panel != null) {
				if (panel.getId().equals("queuetab")) {
					if (panel.getChildren().isEmpty()) {
					    Executions.createComponents("/queuepanel.zul", queuetab, null);
					} else {
					// TODO update existing
					}
				} else if (panel.getId().equals("buildtab")) {
					if (panel.getChildren().isEmpty()) {
					    Executions.createComponents("/buildpanel.zul", buildtab, null);
					} else {
					// TODO update existing
					}
				} else if (panel.getId().equals("historybuildstab")) {
					if (panel.getChildren().isEmpty()) {
					    Executions.createComponents("/historybuildspanel.zul", historybuildstab, null);
					} else {
					// TODO update existing
					}
				} else if (panel.getId().equals("projecttab")) {
					if (panel.getChildren().isEmpty()) {
					    Executions.createComponents("/projectpanel.zul", projecttab, null);
					} else {
					// TODO update existing
					}
				}
			}
			}
			]]></zscript>
		</tabbox>
	</hbox>
</window>
</zk>